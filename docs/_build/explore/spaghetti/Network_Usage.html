---
redirect_from:
  - "/explore/spaghetti/network-usage"
interact_link: content/explore/spaghetti/Network_Usage.ipynb
kernel_name: conda-env-py3_spgh_dev-py
has_widgets: false
title: 'Network_Usage'
prev_page:
  url: /explore/spaghetti/Facility_Location.html
  title: 'Facility_Location'
next_page:
  url: /explore/spaghetti/Snapping_Demonstration.html
  title: 'Snapping_Demonstration'
comment: "***PROGRAMMATICALLY GENERATED, DO NOT EDIT. SEE ORIGINAL FILES IN /content***"
---



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Basic-Tutorial-for-pysal.spaghetti">Basic Tutorial for <code>pysal.spaghetti</code><a class="anchor-link" href="#Basic-Tutorial-for-pysal.spaghetti"> </a></h2>
</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">last_modified</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;posix&quot;</span><span class="p">:</span>
    <span class="n">last_modified</span> <span class="o">=</span> <span class="o">!</span>stat -f<span class="err">\</span>
                    <span class="s2">&quot;# This notebook was last updated: %Sm&quot;</span>\
                     <span class="n">Network_Usage</span><span class="o">.</span><span class="n">ipynb</span>
<span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>
    <span class="n">last_modified</span> <span class="o">=</span> <span class="o">!</span><span class="k">for</span> %a in <span class="o">(</span>Network_Usage.ipynb<span class="o">)</span><span class="err">\</span>
                    <span class="n">do</span> <span class="n">echo</span> <span class="c1"># This notebook was last updated: %~ta</span>
    
<span class="k">if</span> <span class="n">last_modified</span><span class="p">:</span>
    <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">set_next_input</span><span class="p">(</span><span class="n">last_modified</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># This notebook was last updated: May 13 20:21:51 2019</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># pysal submodule imports</span>
<span class="kn">from</span> <span class="nn">pysal.lib</span> <span class="k">import</span> <span class="n">examples</span>
<span class="kn">from</span> <span class="nn">pysal.explore</span> <span class="k">import</span> <span class="n">spaghetti</span> <span class="k">as</span> <span class="n">spgh</span>
<span class="kn">from</span> <span class="nn">pysal.explore</span> <span class="k">import</span> <span class="n">esda</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;James Gaboardi &lt;jgaboardi@gmail.com&gt;&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Instantiate-a-network">Instantiate a network<a class="anchor-link" href="#Instantiate-a-network"> </a></h3>
</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ntw</span> <span class="o">=</span> <span class="n">spgh</span><span class="o">.</span><span class="n">Network</span><span class="p">(</span><span class="n">in_data</span><span class="o">=</span><span class="n">examples</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;streets.shp&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Snap-point-patterns-to-the-network">Snap point patterns to the network<a class="anchor-link" href="#Snap-point-patterns-to-the-network"> </a></h3>
</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Crimes</span>
<span class="n">ntw</span><span class="o">.</span><span class="n">snapobservations</span><span class="p">(</span><span class="n">examples</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;crimes.shp&#39;</span><span class="p">),</span>
                     <span class="s1">&#39;crimes&#39;</span><span class="p">,</span>
                     <span class="n">attribute</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># Schools</span>
<span class="n">ntw</span><span class="o">.</span><span class="n">snapobservations</span><span class="p">(</span><span class="n">examples</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;schools.shp&#39;</span><span class="p">),</span>
                     <span class="s1">&#39;schools&#39;</span><span class="p">,</span>
                     <span class="n">attribute</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="A-network-is-composed-of-a-single-topological-representation-of-roads-and-$n$-point-patterns-which-are-snapped-to-the-network.">A network is composed of a single topological representation of roads and $n$ point patterns which are snapped to the network.<a class="anchor-link" href="#A-network-is-composed-of-a-single-topological-representation-of-roads-and-$n$-point-patterns-which-are-snapped-to-the-network."> </a></h3>
</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ntw</span><span class="o">.</span><span class="n">pointpatterns</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Attributes-for-every-point-pattern">Attributes for every point pattern<a class="anchor-link" href="#Attributes-for-every-point-pattern"> </a></h3>
</div>
</div>
</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ol>
<li><code>dist_snapped</code> dict keyed by pointid with the value as snapped distance from observation to network arc</li>
<li><code>dist_to_vertex</code> dict keyed by pointid with the value being a dict in the form 
<pre><code> {node: distance to vertex, node: distance to vertex}</code></pre>
</li>
<li><code>npoints</code> point observations in set</li>
<li><code>obs_to_arc</code> dict keyed by arc with the value being a dict in the form 
<pre><code> {pointID:(x-coord, y-coord), pointID:(x-coord, y-coord), ... }</code></pre>
</li>
<li><code>obs_to_vertex</code> list of incident network vertices to snapped observation points</li>
<li><code>points</code> geojson like representation of the point pattern.  Includes properties if read with attributes=True</li>
<li><code>snapped_coordinates</code> dict keyed by pointid with the value being (x-coord, y-coord)</li>
</ol>

</div>
</div>
</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Counts-per-link-(arc-or-edge)-are-important,-but-should-not-be-precomputed-since-we-have-different-representations-of-the-network-(spatial-and-graph-currently).--(Relatively)-Uniform-segmentation-still-needs-to-be-done.">Counts per link (arc or edge) are important, but should not be precomputed since we have different representations of the network (spatial and graph currently).  (Relatively) Uniform segmentation still needs to be done.<a class="anchor-link" href="#Counts-per-link-(arc-or-edge)-are-important,-but-should-not-be-precomputed-since-we-have-different-representations-of-the-network-(spatial-and-graph-currently).--(Relatively)-Uniform-segmentation-still-needs-to-be-done."> </a></h3>
</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">counts</span> <span class="o">=</span> <span class="n">ntw</span><span class="o">.</span><span class="n">count_per_link</span><span class="p">(</span><span class="n">ntw</span><span class="o">.</span><span class="n">pointpatterns</span><span class="p">[</span><span class="s1">&#39;crimes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">obs_to_arc</span><span class="p">,</span>
                            <span class="n">graph</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Network-segmentation">Network segmentation<a class="anchor-link" href="#Network-segmentation"> </a></h3>
</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">n200</span> <span class="o">=</span> <span class="n">ntw</span><span class="o">.</span><span class="n">split_arcs</span><span class="p">(</span><span class="mf">200.0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">counts</span> <span class="o">=</span> <span class="n">n200</span><span class="o">.</span><span class="n">count_per_link</span><span class="p">(</span><span class="n">n200</span><span class="o">.</span><span class="n">pointpatterns</span><span class="p">[</span><span class="s1">&#39;crimes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">obs_to_arc</span><span class="p">,</span>
                             <span class="n">graph</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Create-geopandas.GeoDataFrame-objects-of-the-vertices-and-arcs">Create <code>geopandas.GeoDataFrame</code> objects of the vertices and arcs<a class="anchor-link" href="#Create-geopandas.GeoDataFrame-objects-of-the-vertices-and-arcs"> </a></h3>
</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># &#39;full&#39; unsegmented network</span>
<span class="n">vertices_df</span><span class="p">,</span> <span class="n">arcs_df</span> <span class="o">=</span> <span class="n">spgh</span><span class="o">.</span><span class="n">element_as_gdf</span><span class="p">(</span><span class="n">ntw</span><span class="p">,</span>
                                           <span class="n">vertices</span><span class="o">=</span><span class="n">ntw</span><span class="o">.</span><span class="n">vertex_coords</span><span class="p">,</span>
                                           <span class="n">arcs</span><span class="o">=</span><span class="n">ntw</span><span class="o">.</span><span class="n">arcs</span><span class="p">)</span>

<span class="c1"># network segmented at 200-meter increments</span>
<span class="n">vertices200_df</span><span class="p">,</span> <span class="n">arcs200_df</span> <span class="o">=</span> <span class="n">spgh</span><span class="o">.</span><span class="n">element_as_gdf</span><span class="p">(</span><span class="n">n200</span><span class="p">,</span>
                                                 <span class="n">vertices</span><span class="o">=</span><span class="n">n200</span><span class="o">.</span><span class="n">vertex_coords</span><span class="p">,</span>
                                                 <span class="n">arcs</span><span class="o">=</span><span class="n">n200</span><span class="o">.</span><span class="n">arcs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Visualization-of-the-shapefile-derived,-unsegmented-network-with-vertices-in-a-larger,-blue,-semi-opaque-form-and-the-distance-segmented-network-with-small,-red,-fully-opaque-vertices.">Visualization of the shapefile derived, unsegmented network with vertices in a larger, blue, semi-opaque form and the distance segmented network with small, red, fully opaque vertices.<a class="anchor-link" href="#Visualization-of-the-shapefile-derived,-unsegmented-network-with-vertices-in-a-larger,-blue,-semi-opaque-form-and-the-distance-segmented-network-with-small,-red,-fully-opaque-vertices."> </a></h3>
</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">base</span> <span class="o">=</span> <span class="n">arcs_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">25</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">vertices_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">base</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">25</span><span class="p">)</span>
<span class="n">arcs200_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">base</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">25</span><span class="p">)</span>
<span class="n">vertices200_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">base</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Moran's-I-using-the-digitized-network">Moran's I using the digitized network<a class="anchor-link" href="#Moran's-I-using-the-digitized-network"> </a></h3>
</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Binary Adjacency</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">ntw</span><span class="o">.</span><span class="n">contiguityweights</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Build the y vector</span>
<span class="n">arcs</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">neighbors</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arcs</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arcs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>

<span class="c1"># Moran&#39;s I</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">esda</span><span class="o">.</span><span class="n">moran</span><span class="o">.</span><span class="n">Moran</span><span class="p">(</span><span class="n">y</span><span class="p">,</span>
                       <span class="n">w</span><span class="p">,</span>
                       <span class="n">permutations</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Moran's-I-using-the-graph-representation-to-generate-the-W">Moran's I using the graph representation to generate the W<a class="anchor-link" href="#Moran's-I-using-the-graph-representation-to-generate-the-W"> </a></h3><ul>
<li>Note that we have to regenerate the counts per arc, since the graph will have less edges.</li>
</ul>

</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">counts</span> <span class="o">=</span> <span class="n">ntw</span><span class="o">.</span><span class="n">count_per_link</span><span class="p">(</span><span class="n">ntw</span><span class="o">.</span><span class="n">pointpatterns</span><span class="p">[</span><span class="s1">&#39;crimes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">obs_to_arc</span><span class="p">,</span>
                            <span class="n">graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Binary Adjacency</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">ntw</span><span class="o">.</span><span class="n">contiguityweights</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Build the y vector</span>
<span class="n">edges</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">neighbors</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>

<span class="c1"># Moran&#39;s I</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">esda</span><span class="o">.</span><span class="n">moran</span><span class="o">.</span><span class="n">Moran</span><span class="p">(</span><span class="n">y</span><span class="p">,</span>
                       <span class="n">w</span><span class="p">,</span>
                       <span class="n">permutations</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Moran's-I-using-the-segmented-network-and-intensities-instead-of-counts">Moran's I using the segmented network and intensities instead of counts<a class="anchor-link" href="#Moran's-I-using-the-segmented-network-and-intensities-instead-of-counts"> </a></h3>
</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Binary Adjacency</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">n200</span><span class="o">.</span><span class="n">contiguityweights</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Compute the counts</span>
<span class="n">counts</span> <span class="o">=</span> <span class="n">n200</span><span class="o">.</span><span class="n">count_per_link</span><span class="p">(</span><span class="n">n200</span><span class="o">.</span><span class="n">pointpatterns</span><span class="p">[</span><span class="s1">&#39;crimes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">obs_to_arc</span><span class="p">,</span>
                             <span class="n">graph</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Build the y vector and convert from raw counts to intensities</span>
<span class="n">arcs</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">neighbors</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arcs</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">n200</span><span class="o">.</span><span class="n">arc_lengths</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">/</span> <span class="n">length</span>

<span class="c1"># Moran&#39;s I</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">esda</span><span class="o">.</span><span class="n">moran</span><span class="o">.</span><span class="n">Moran</span><span class="p">(</span><span class="n">y</span><span class="p">,</span>
                       <span class="n">w</span><span class="p">,</span>
                       <span class="n">permutations</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Timings-for-distance-based-methods,-e.g.-G-function">Timings for distance based methods, e.g. G-function<a class="anchor-link" href="#Timings-for-distance-based-methods,-e.g.-G-function"> </a></h3>
</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">n0</span> <span class="o">=</span> <span class="n">ntw</span><span class="o">.</span><span class="n">allneighbordistances</span><span class="p">(</span><span class="n">ntw</span><span class="o">.</span><span class="n">pointpatterns</span><span class="p">[</span><span class="s1">&#39;crimes&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">n1</span> <span class="o">=</span> <span class="n">n200</span><span class="o">.</span><span class="n">allneighbordistances</span><span class="p">(</span><span class="n">n200</span><span class="o">.</span><span class="n">pointpatterns</span><span class="p">[</span><span class="s1">&#39;crimes&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Note that the first time these methods are called, the underlying vertex-to-vertex shortest path distance matrix has to be calculated. Subsequent calls will not require this, and will be much faster:</li>
</ul>

</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">n0</span> <span class="o">=</span> <span class="n">ntw</span><span class="o">.</span><span class="n">allneighbordistances</span><span class="p">(</span><span class="n">ntw</span><span class="o">.</span><span class="n">pointpatterns</span><span class="p">[</span><span class="s1">&#39;crimes&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">n1</span> <span class="o">=</span> <span class="n">n200</span><span class="o">.</span><span class="n">allneighbordistances</span><span class="p">(</span><span class="n">n200</span><span class="o">.</span><span class="n">pointpatterns</span><span class="p">[</span><span class="s1">&#39;crimes&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Simulate-a-point-pattern-on-the-network">Simulate a point pattern on the network<a class="anchor-link" href="#Simulate-a-point-pattern-on-the-network"> </a></h3><ul>
<li>Need to supply a count of the number of points and a distirbution (default is uniform).  Generally, this will not be called by the user, since the simulation will be used for Monte Carlo permutation.</li>
</ul>

</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">npts</span> <span class="o">=</span> <span class="n">ntw</span><span class="o">.</span><span class="n">pointpatterns</span><span class="p">[</span><span class="s1">&#39;crimes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">npoints</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">ntw</span><span class="o">.</span><span class="n">simulate_observations</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>
<span class="n">sim</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="F-function">F-function<a class="anchor-link" href="#F-function"> </a></h3>
</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fres</span> <span class="o">=</span> <span class="n">ntw</span><span class="o">.</span><span class="n">NetworkF</span><span class="p">(</span><span class="n">ntw</span><span class="o">.</span><span class="n">pointpatterns</span><span class="p">[</span><span class="s1">&#39;crimes&#39;</span><span class="p">],</span>
                    <span class="n">permutations</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fres</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">fres</span><span class="o">.</span><span class="n">observed</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fres</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">fres</span><span class="o">.</span><span class="n">upperenvelope</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Upper&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fres</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">fres</span><span class="o">.</span><span class="n">lowerenvelope</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Lower&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Network F Function&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;xx-large&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Create-a-nearest-neighbor-matrix-using-the-crimes-point-pattern">Create a nearest neighbor matrix using the crimes point pattern<a class="anchor-link" href="#Create-a-nearest-neighbor-matrix-using-the-crimes-point-pattern"> </a></h3><ul>
<li>[note from jlaura] Right now, both the G and K functions generate a full distance matrix.  This is because, I know that the full generation is correct and I believe that the truncated generated, e.g. nearest neighbor, has a bug.</li>
</ul>

</div>
</div>
</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="G-function">G-function<a class="anchor-link" href="#G-function"> </a></h3>
</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">gres</span> <span class="o">=</span> <span class="n">ntw</span><span class="o">.</span><span class="n">NetworkG</span><span class="p">(</span><span class="n">ntw</span><span class="o">.</span><span class="n">pointpatterns</span><span class="p">[</span><span class="s1">&#39;crimes&#39;</span><span class="p">],</span>
                    <span class="n">permutations</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gres</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">gres</span><span class="o">.</span><span class="n">observed</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gres</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">gres</span><span class="o">.</span><span class="n">upperenvelope</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Upper&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gres</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">gres</span><span class="o">.</span><span class="n">lowerenvelope</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Lower&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Network G Function&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;xx-large&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="K-function">K-function<a class="anchor-link" href="#K-function"> </a></h3>
</div>
</div>
</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">kres</span> <span class="o">=</span> <span class="n">ntw</span><span class="o">.</span><span class="n">NetworkK</span><span class="p">(</span><span class="n">ntw</span><span class="o">.</span><span class="n">pointpatterns</span><span class="p">[</span><span class="s1">&#39;crimes&#39;</span><span class="p">],</span>
                    <span class="n">permutations</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing code_cell rendered">

<div class="jb_input" >
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kres</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">kres</span><span class="o">.</span><span class="n">observed</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kres</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">kres</span><span class="o">.</span><span class="n">upperenvelope</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Upper&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kres</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">kres</span><span class="o">.</span><span class="n">lowerenvelope</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Lower&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Network K Function&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;xx-large&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>



</div>



<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>

 

